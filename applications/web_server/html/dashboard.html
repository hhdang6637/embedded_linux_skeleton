<!-- <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">CPU USAGE (%)</h1>
</div> -->

<hr>
<style>
    canvas{
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    .cpu-chart-container {
        width: 500px;
        margin-left: 40px;
        margin-right: 40px;
        margin-bottom: 40px;
    }
    .ram-chart-container {
        width: 500px;
        margin-left: 40px;
        margin-right: 40px;
        margin-bottom: 40px;
    }
    .net-tx-chart-container {
        width: 500px;
        margin-left: 40px;
        margin-right: 40px;
        margin-bottom: 40px;
    }
    .net-rx-chart-container {
        width: 500px;
        margin-left: 40px;
        margin-right: 40px;
        margin-bottom: 40px;
    }
    .cpu_chart_canvas {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }
    .ram_chart_canvas {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }
    .net_tx_chart_canvas {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }
    .net_rx_chart_canvas {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
    }
</style>
<div class="row">
    <div id="cpu-chart-container" style="padding-left: 2%; padding-right: 2%;" class="col-lg-6 col-md-12">
        <canvas id="cpu_chart_canvas"></canvas>
    </div>

    <div id="ram-chart-container" style="padding-left: 2%; padding-right: 2%;" class="col-lg-6 col-md-12">
        <canvas id="ram_chart_canvas"></canvas>
    </div>
</div>

<p id="demo"></p>

<div class="row">
    <div id="net-tx-chart-container" style="padding-left: 2%; padding-right: 2%;" class="col-lg-6 col-md-12">
        <canvas id="net_tx_chart_canvas"></canvas>
    </div>

    <div id="net-rx-chart-container" style="padding-left: 2%; padding-right: 2%;" class="col-lg-6 col-md-12">
        <canvas id="net_rx_chart_canvas"></canvas>
    </div>
</div>

<!-- ChartJs -->
<script src="/js/plugins/chartjs/Chart.bundle.js"></script>
<script>

$(function () {
    $("#myTopnav").find("a[href='/pages/dashboard']").addClass("active")
});

//////////////////////////////////////////////////////
    // CPU chart setup
//////////////////////////////////////////////////////

var second_datas = [];
for(i = 60; i >= 0; i--) {
    second_datas.push(i);
}

var cpu_percents = [];
var ram_usage = [];
var net_tx_stat = [];
var net_rx_stat = [];


var cpu_config = {
    type: 'line',
    data: {
        labels: second_datas,
        datasets: [{
            label: 'CPU Percents',
            backgroundColor: 'rgb(255, 110, 0)',
            borderColor: 'rgb(255, 99, 132)',
            data: cpu_percents,
            fill: true,
        }]
    },
    options: {
        responsive: true,
        title: { display: true, text: 'CPU USAGE (%)'},
        tooltips: { mode: 'index', intersect: false, },
        hover: { mode: 'nearest', intersect: true },
        scales: {
            xAxes: [{
                display: false,
                scaleLabel: { display: false, labelString: 'Seconds' },
                // ticks: { min: 0, max: 40, stepSize: 5, reverse: false, },
            }],
            yAxes: [{
                display: true,
                scaleLabel: { display: false, labelString: 'Percents' },
                ticks: { min: 0, max: 100, stepSize: 20, reverse: false, },
            }]
        },
        animation: {
            duration: 0
        }
    }
};

// RAM chart setup

var ram_config = {
    type: 'line',
    data: {
        labels: second_datas,
        datasets: [{
            label: 'MEMORY Percents',
            backgroundColor: 'rgb(171, 23, 83)',
            borderColor: 'rgb(255, 255, 255)',
            data: ram_usage,
            fill: true,
        }]
    },
    options: {
        responsive: true,
        title: { display: true, text: 'MEMORY USAGE (%)'},
        tooltips: { mode: 'index', intersect: false, },
        hover: { mode: 'nearest', intersect: true },
        scales: {
            xAxes: [{
                display: false,
                scaleLabel: { display: false, labelString: 'Seconds' },
                // ticks: { min: 0, max: 40, stepSize: 5, reverse: false, },
            }],
            yAxes: [{
                display: true,
                scaleLabel: { display: false, labelString: 'Percents' },
                ticks: { min: 0, max: 100, stepSize: 20, reverse: false, },
            }]
        },
        animation: {
            duration: 0
        }
    }
};

// NET chart setup

var net_tx_config = {
    type: 'line',
    data: {
        labels: second_datas,
        datasets: [{
            label: 'TX Statistics',
            backgroundColor: 'rgb(171, 23, 183)',
            borderColor: 'rgb(255, 255, 255)',
            data: net_tx_stat,
            fill: true,
        }]
    },
    options: {
        responsive: true,
        title: { display: true, text: 'Transmit (/s)'},
        tooltips: { mode: 'index', intersect: false, },
        hover: { mode: 'nearest', intersect: true },
        scales: {
            xAxes: [{
                display: false,
                scaleLabel: { display: false, labelString: '/s' },
                // ticks: { min: 0, max: 40, stepSize: 5, reverse: false, },
            }],
            yAxes: [{
                display: true,
                scaleLabel: { display: false, labelString: '/s' },
                ticks: { min: 0, max: 100, stepSize: 20, reverse: false, },
            }]
        },
        animation: {
            duration: 0
        }
    }
};
var net_rx_config = {
    type: 'line',
    data: {
        labels: second_datas,
        datasets: [{
            label: 'RX Statistics',
            backgroundColor: 'rgb(171, 123, 83)',
            borderColor: 'rgb(255, 255, 255)',
            data: net_rx_stat,
            fill: true,
        }]
    },
    options: {
        responsive: true,
        title: { display: true, text: 'Transmit (/s)'},
        tooltips: { mode: 'index', intersect: false, },
        hover: { mode: 'nearest', intersect: true },
        scales: {
            xAxes: [{
                display: false,
                scaleLabel: { display: false, labelString: '/s' },
                // ticks: { min: 0, max: 40, stepSize: 5, reverse: false, },
            }],
            yAxes: [{
                display: true,
                scaleLabel: { display: false, labelString: '/s' },
                ticks: { min: 0, max: 100, stepSize: 20, reverse: false, },
            }]
        },
        animation: {
            duration: 0
        }
    }
};


var realtime = 'on';

var net_tx_max;
var net_rx_max;

function updateRealTime() {

    $.getJSON( "/json/resource_usage_history", function( data ) {
        var ram_used_mb = Math.floor((data.json_ram_total - data.json_ram_free) / 1024 / 1024);
        var ram_total_mb = Math.floor(data.json_ram_total / 1024 / 1024);
        window.cpuLine.options.title.text = 'CPU USAGE (' + data.json_cpu_usage_history[data.json_cpu_usage_history.length - 1] + '%)';
        window.ramLine.options.title.text = 'MEMORY USAGE ' + ram_used_mb +
            'MB (' + data.json_ram_history[data.json_ram_history.length - 1] + ' %) of ' + ram_total_mb + ' MB';

        var net_tx_cur = data.json_network_history.tx_bytes[data.json_network_history.tx_bytes.length - 1];
        var tx_round;
        if (net_tx_cur > 1000) {
            tx_round = Math.floor((net_tx_cur/1000) * 100) / 100; //round 2 digits
            window.netTxLine.options.title.text = 'TX (' + tx_round + ' Mbps)';
        } else {
            tx_round = Math.floor((net_tx_cur) * 100) / 100; //round 2 digits
            window.netTxLine.options.title.text = 'TX (' + tx_round + ' Kbps)';
        }

        var net_rx_cur = data.json_network_history.rx_bytes[data.json_network_history.rx_bytes.length - 1];
        var rx_round;
        if (net_rx_cur > 1000) {
            rx_round = Math.floor((net_rx_cur/1000) * 100) / 100; //round 2 digits
            window.netRxLine.options.title.text = 'RX (' + rx_round + ' Mbps)';
        } else {
            rx_round = Math.floor((net_rx_cur) * 100) / 100; //round 2 digits
            window.netRxLine.options.title.text = 'RX (' + rx_round + ' Kbps)';
        }


        cpu_config.data.datasets.forEach(function(dataset) {
            dataset.data = data.json_cpu_usage_history;
        });
        ram_config.data.datasets.forEach(function(dataset) {
            dataset.data = data.json_ram_history;
        });

        net_tx_config.data.datasets.forEach(function(dataset) {
            dataset.data = data.json_network_history.tx_bytes;
        });
        net_rx_config.data.datasets.forEach(function(dataset) {
            dataset.data = data.json_network_history.rx_bytes;
        });

        net_tx_max = Math.max.apply(null, data.json_network_history.tx_bytes);
        net_rx_max = Math.max.apply(null, data.json_network_history.rx_bytes);

        if (net_tx_max/1000 < 20) {
            window.netTxLine.options.scales.yAxes[0].ticks.max = net_tx_max*2;
        } else {
            window.netTxLine.options.scales.yAxes[0].ticks.max = net_tx_max;
        }
        if (net_rx_max/1000 < 20) {
            window.netRxLine.options.scales.yAxes[0].ticks.max = net_rx_max*2;
        } else {
            window.netRxLine.options.scales.yAxes[0].ticks.max = net_rx_max;
        }

        if (data.json_network_history.max_tx_bytes > 0) {
            window.netTxLine.options.scales.yAxes[0].ticks.max = data.json_network_history.max_tx_bytes;
            window.netRxLine.options.scales.yAxes[0].ticks.max = data.json_network_history.max_rx_bytes;
        }

        window.netTxLine.options.scales.yAxes[0].ticks.stepSize = window.netTxLine.options.scales.yAxes[0].ticks.max/5;
        window.netRxLine.options.scales.yAxes[0].ticks.stepSize = window.netRxLine.options.scales.yAxes[0].ticks.max/5;

        window.netTxLine.update();
        window.netRxLine.update();
        window.cpuLine.update();
        window.ramLine.update();
    });

    var timeout;
    if (realtime === 'on') {
        timeout = setTimeout(updateRealTime, 1000);
    } else {
        clearTimeout(timeout);
    }
}

window.onload = function() {
    var cpu_ctx = document.getElementById('cpu_chart_canvas').getContext('2d');
    var ram_ctx = document.getElementById('ram_chart_canvas').getContext('2d');
    var net_tx_ctx = document.getElementById('net_tx_chart_canvas').getContext('2d');
    var net_rx_ctx = document.getElementById('net_rx_chart_canvas').getContext('2d');
    window.cpuLine = new Chart(cpu_ctx, cpu_config);
    window.ramLine = new Chart(ram_ctx, ram_config);
    window.netTxLine = new Chart(net_tx_ctx, net_tx_config);
    window.netRxLine = new Chart(net_rx_ctx, net_rx_config);
    updateRealTime();
};

</script>
