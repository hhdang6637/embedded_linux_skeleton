<style>

/* Style the tab */
.tab {
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #f1f1f1;
}
/* Style the buttons that are used to open the tab content */
.tab button {
    background-color: rgba(0,123,255,.25);
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 14px 16px;
    transition: 0.3s;
}
/* Change background color of buttons on hover */
.tab button:hover {
    background-color: #ddd;
}
/* Create an active/current tablink class */
.tab button.active {
    background-color: #4d94ff;
}
/* Style the tab content */
.tabcontent {
    display: none;
    padding: 6px 12px;
    border: 1px solid #ccc;
    border-top: none;
}

.tabcontent {
    animation: fadeEffect 1s; /* Fading effect takes 1 second */
}

/* Go from zero to full opacity */
@keyframes fadeEffect {
    from {opacity: 0;}
    to {opacity: 1;}
}
</style>

<div class="container">
    <div class="status"></div>
    <div class="tab">
        <button id="defaultOpen" class="tablinks" onclick="openTab(event, 'VPN_CFG')">VPN Configuration</button>
        <button class="tablinks" onclick="openTab(event, 'CA_INFO')">CA & Server Information</button>
        <button class="tablinks" onclick="openTab(event, 'CLIENT_INFO')">Client Information</button>
    </div>
    <!-- Tab content -->
    <div id="VPN_CFG" class="tabcontent card">
        <div class="card-body">
            <h5 class="card-title text-center">VPN Configuration</h5>
            <form action="/json/openvpn_cfg" method="post" enctype="multipart/form-data" id="js-openvpn_setting-form">
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enable_vpn" name="enable_vpn">
                        <label class="form-check-label" for="enable_vpn">Enable VPN Server</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="port">Port:</label>
                    <input type="text" class="form-control" id="port" name="port" placeholder="Port">
                </div>
                <div class="row justify-content-md-center">
                    <button type="submit" class="btn btn-primary">Apply</button>
                </div>
            </form>
        </div>
    </div>
    <div id="CA_INFO" class="tabcontent card">
        <div class="cardcurrentTarget-body">
            <h5 class="card-title text-center">CA and Server Certificate</h5>
            <form action="/json/openvpn_rsa" method="post" enctype="multipart/form-data" id="js-openvpn_rsa-form">
                <div class="form-group">
                    <label for="ca">CA:</label>
                    <input type="text" class="form-control" id="ca" name="ca" placeholder="CA name">
                </div>
                <div class="form-group">
                    <label for="server">Server:</label>
                    <input type="text" class="form-control" id="server" name="server" placeholder="Server name">
                </div>
                <div class="row justify-content-md-center">
                    <button type="submit" class="btn btn-primary">Generate RSA suite</button>
                </div>
            </form>
        </div>
    </div>
    <div id="CLIENT_INFO" class="tabcontent card">
        <div class="card-body">
            <h5 class="card-title text-center">Client Certificates</h5>
            <table id='table' class="table table-hover">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Common Name</th>
                        <th>Expire date</th>
                        <th>State</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div class="btn-toolbar d-flex justify-content-center" role="toolbar" aria-label="Toolbar with button groups">
                <div class="btn-group mr-2" role="group" aria-label="First group">
                    <button type="button" onclick="gen_client_cert()" class="btn btn-primary">Generate Cert</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
$(function () {
    $("#myTopnav").find("a[href='/pages/openvpn']").addClass("active")
});

+ function($) {
    'use strict';

    $(document).ready(function(){
        showInfor();
        showCert();
        showClient_Cert()
    });

    function showInfor()
    {
        $.getJSON( "/json/openvpn_cfg", function(data) {

            var infor_conf = data.json_openvpn_config;

            $("#port").val(infor_conf.port);

            if (infor_conf.state == 1) {
                $("#enable_vpn").prop('checked', true);
            } else {
                $("#enable_vpn").prop('checked', false);
            }

        });
    }

    var openvpn_ConfigForm = document.getElementById('js-openvpn_setting-form');

    openvpn_ConfigForm.addEventListener('submit', function(e) {
        e.preventDefault();
        post_form_data($, 'js-openvpn_setting-form', function(json) {
        $(".status").empty();
            if (json.status == "succeeded") {
              $(".status").append("<div class=\"alert alert-success\"> <strong>Success!</strong></div>");
            } else {
              $(".status").append("<div class=\"alert alert-danger\"> <strong>Error!</strong> " + json.message + "</div>");
              showInfor();
            }
        });
    })

    function showCert()
    {
        $.getJSON( "/json/openvpn_rsa", function(data) {

            var cert = data.json_openvpn_rsa;

            $("#ca").val(cert.ca_name);
            $("#server").val(cert.server_name);
        });
    }

    var openvpn_RsaForm = document.getElementById('js-openvpn_rsa-form');
    openvpn_RsaForm.addEventListener('submit', function(e) {
        e.preventDefault();
       if (confirm("This action will remove all current client profiles too!!!") == true) {
            post_form_data($, 'js-openvpn_rsa-form', function(json) {
            $(".status").empty();
                if (json.status == "succeeded") {
                  $(".status").append("<div class=\"alert alert-success\"> <strong>Success!</strong></div>");
                } else {
                  $(".status").append("<div class=\"alert alert-danger\"> <strong>Error!</strong> " + json.message + "</div>");
                }
                showCert();
            });
        }
    })

    function showClient_Cert()
    {
        $.getJSON( "/json/openvpn_client_cert", function(data) {

            var html = "";
            var jsClient_Cert = data.json_client_cert;
            for (var i = 0; i < jsClient_Cert.length; i++) {
                var client = jsClient_Cert[i];

                html += "<tr><td>" + client.email + "</td><td>" + client.name + "</td><td>" + client.expire + "</td><td>" + client.state + "</td><td class=\"text-center\"><button type=\"button\" onclick=\"downLoad('" + client.name + "')\"" + "class=\"btn btn-sm btn-primary\">" + "Download" + "</button>&ensp;<button type=\"button\" class=\"btn btn-sm btn-danger\">" + "Revoke" + "</button></td></tr>";
            }
            $('#table > tbody:last-child').append(html);
        });
    }

}(jQuery);

function post_form_data($, id, onSuccess) {

    var formData = new FormData();
    $.each($('#' + id +' [name]'), function(i, elem) {
        if ($(elem).attr('type') == 'checkbox')
        {
            formData.append($(elem).attr('name'), $(elem).prop('checked'));
        } else {
            formData.append($(elem).attr('name'), $(elem).val());
        }
    });

    $.ajax({
        type: "POST",
        url: $('#' + id).attr('action'),
        data: formData,
        enctype: 'multipart/form-data',
        processData: false,
        contentType: false,
        cache: false,

        success: onSuccess,
    });
}

function gen_client_cert()
{
    var email = prompt("Please enter the certificate email:", "");
    var common_name = prompt("Please enter the certificate common name:", "");

    var formData = new FormData();

    if (email != null && common_name != null) {
        formData.append('email', email);
        formData.append('common_name', common_name);

        $.ajax({
            type: "POST",
            url: "/json/openvpn_client_cert",
            data: formData,
            enctype: 'multipart/form-data',
            processData: false,
            contentType: false,
            cache: false,

            success: function(json) {
                if (json.status == "succeeded") {
                  $(".status").append("<div class=\"alert alert-success\"> <strong>Success!</strong></div>");
                } else {
                  $(".status").append("<div class=\"alert alert-danger\"> <strong>Error!</strong> " + json.message + "</div>");
                }
            },
        });
    }
}

function openTab(evt, tabName) {
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

document.getElementById("defaultOpen").click();

</script>
